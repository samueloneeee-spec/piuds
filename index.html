<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Punch Ball Force</title>
<style>
body { margin:0; background:black; color:white; font-family:"Courier New", monospace; text-align:center; overflow:hidden; }
video, canvas { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
#forza { position:absolute; top:20px; left:50%; transform:translateX(-50%); font-size:64px; font-weight:bold; color:#00ffcc; text-shadow:0 0 15px #00ffff,0 0 30px #00ffff; background:rgba(0,0,0,0.6); padding:15px 30px; border-radius:15px; transition: transform 0.2s, color 0.2s; }
.flash { color:#ff0055 !important; text-shadow:0 0 20px #ff0055,0 0 40px #ff0055; transform:scale(1.3);}
#startBtn,#playAgainBtn { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:32px; padding:20px 40px; border-radius:20px; border:none; background:#00ffcc; color:black; font-weight:bold; cursor:pointer; z-index:10;}
#playAgainBtn{display:none;}
</style>
</head>
<body>
<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>
<div id="forza">Forza: 0</div>
<button id="startBtn">Inizia</button>
<button id="playAgainBtn">Gioca Ancora</button>
<audio id="hitSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const forzaLabel = document.getElementById("forza");
const hitSound = document.getElementById("hitSound");
const startBtn = document.getElementById("startBtn");
const playAgainBtn = document.getElementById("playAgainBtn");

let punteggioBloccato = false;
let ready = false; // punteggio parte solo dopo movimento reale
let lastPositions = [];
let forzaAttuale = 0;

startBtn.addEventListener('click', async () => {
    startBtn.style.display = 'none';
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    video.play();
    processFrame();
});

playAgainBtn.addEventListener('click', ()=>{
    punteggioBloccato = false;
    ready = false;
    forzaAttuale = 0;
    lastPositions = [];
    forzaLabel.textContent = "Forza: 0";
    playAgainBtn.style.display='none';
});

function processFrame(){
    canvas.width = video.videoWidth || window.innerWidth;
    canvas.height = video.videoHeight || window.innerHeight;

    function process(){
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const frame = ctx.getImageData(0,0,canvas.width,canvas.height);
        const data = frame.data;

        let redX=0, redY=0, count=0;
        const minPixels = 80;

        // rilevamento punch ball rosso intenso
        for(let i=0;i<data.length;i+=4){
            const r=data[i], g=data[i+1], b=data[i+2];
            const rgbSum = r+g+b;
            if(r>150 && g<100 && b<100 && rgbSum<400){
                const idx = i/4;
                const x = idx%canvas.width;
                const y = Math.floor(idx/canvas.width);
                redX+=x; redY+=y; count++;
            }
        }

        if(count>=minPixels && !punteggioBloccato){
            const avgX = redX/count;
            const avgY = redY/count;

            lastPositions.push({x: avgX, y: avgY});
            if(lastPositions.length>5) lastPositions.shift();

            const sum = lastPositions.reduce((acc,p)=>{acc.x+=p.x; acc.y+=p.y; return acc;},{x:0,y:0});
            const centerX = sum.x/lastPositions.length;
            const centerY = sum.y/lastPositions.length;

            ctx.beginPath();
            ctx.arc(centerX,centerY,20,0,2*Math.PI);
            ctx.strokeStyle="lime";
            ctx.lineWidth=4;
            ctx.stroke();

            if(lastPositions.length>=2){
                const dx = centerX - lastPositions[lastPositions.length-2].x;
                const dy = centerY - lastPositions[lastPositions.length-2].y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                const speed = dist*60; // assume 60fps

                // logica ready: punteggio parte solo se movimento reale
                if(!ready && speed>20){
                    ready = true;
                }

                if(ready && speed>30){ // calcolo forza solo se colpo significativo
                    let forzaCalcolata = Math.min(999, Math.floor(Math.log(speed)*200));
                    if(forzaCalcolata>100){
                        forzaAttuale += (forzaCalcolata-forzaAttuale)*0.1;
                        forzaLabel.textContent = "Forza: " + Math.floor(forzaAttuale);
                    }

                    // colpo rilevato: blocca punteggio
                    if(speed>40 && !punteggioBloccato){
                        punteggioBloccato = true;
                        forzaAttuale = Math.floor(forzaAttuale);
                        forzaLabel.textContent = "Forza: " + forzaAttuale;
                        playAgainBtn.style.display='block';

                        if(forzaAttuale > 800){
                            forzaLabel.classList.add("flash");
                            hitSound.play().catch(()=>{});
                            setTimeout(()=>forzaLabel.classList.remove("flash"),300);
